<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FloorPlan AI</title>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f4f4f4;
}

header {
    background: #1f2937;
    color: white;
    padding: 15px 30px;
}

header h1 { margin: 0; font-size: 22px; }
header p { margin: 2px 0 0; font-size: 13px; color: #d1d5db; }

.container {
    display: flex;
    height: calc(100vh - 70px);
}

.chat-panel {
    width: 40%;
    background: #111827;
    color: white;
    padding: 20px;
    display: flex;
    flex-direction: column;
}

.chat-header { font-weight: bold; margin-bottom: 10px; }

.chat-history {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    background: #1f2937;
    border-radius: 6px;
}

.message {
    margin-bottom: 10px;
    max-width: 85%;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 14px;
}

.message.bot { background: #374151; }
.message.user { background: #2563eb; margin-left: auto; }

.chat-input {
    display: flex;
    margin-top: 10px;
    gap: 5px;
}

.chat-input input {
    flex: 1;
    padding: 10px;
}

.chat-input button {
    padding: 10px 15px;
    background: #2563eb;
    color: white;
    border: none;
    border-radius: 4px;
}

.plan-panel {
    width: 60%;
    padding: 20px;
    background: #0f172a;
    color: #aaa;
    overflow: auto;
}

.placeholder {
    border: 2px dashed #555;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.action-buttons {
    display: flex;
    gap: 10px;
    margin: 10px;
    justify-content: center;
}

.action-buttons button {
    padding: 8px 16px;
    border-radius: 6px;
    border: none;
    color: white;
    cursor: pointer;
}

.action-buttons button:nth-child(1) { background: purple; }
.action-buttons button:nth-child(2) { background: teal; }
.action-buttons button:nth-child(3) { background: green; }
</style>
</head>

<body>

<header>
    <h1>FloorPlan AI</h1>
    <p>Design Your Dream Space</p>
</header>

<div class="container">

<div class="chat-panel">
    <div class="chat-header" id="stepHeader">Step 1 of 9</div>
    <div class="chat-history" id="chatHistory"></div>

    <div class="chat-input">
        <input type="text" id="userInput" placeholder="Type your answer..." />
        <button onclick="sendMessage()">Send</button>
    </div>
</div>

<div class="plan-panel">
    <div class="placeholder" id="planPreview">
        Floor plan preview will appear here
    </div>
</div>

</div>

<div class="action-buttons">
    <button onclick="modifyPlan()">Modify</button>
    <button onclick="savePlan()">Save</button>
    <button onclick="downloadSVG()">Download</button>
</div>

<script>
const questions = [
    "What type of house do you want? (2BHK, 3BHK, Studio)",
    "What is the total plot size? (e.g., 30x40 feet)",
    "What is the plot facing direction? (North, South, East, West)",
    "What shape do you prefer? (Square, Rectangular, L-shaped)",
    "Enter bedroom sizes in order (e.g., 12x13, 11x12, 10x12)",
    "How many ATTACHED bathrooms and which bedroom? (e.g., Bedroom 1 5x8)",
    "How many COMMON (separate) bathrooms? (e.g., 1 common 5x7)",
    "Kitchen details? (Open/Closed and size, e.g., closed 10x12)",
    "Living & Dining details? (Combined/Separate and size, e.g., separate 12x14)",
    "Any additional features? (Balcony, storage, stairs, etc.)"
];


let currentStep = 0;
let answers = {};
let awaitingConfirmation = false;

// ðŸ”¥ Add here
let modifyMode = false;
let modifyStep = null;


const chatHistory = document.getElementById("chatHistory");
const stepHeader = document.getElementById("stepHeader");
const userInput = document.getElementById("userInput");
userInput.addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
        sendMessage();
    }
});

function addBotMessage(text) {
    const msg = document.createElement("div");
    msg.className = "message bot";
    msg.innerText = text;
    chatHistory.appendChild(msg);
    chatHistory.scrollTop = chatHistory.scrollHeight;
}

function addUserMessage(text) {
    const msg = document.createElement("div");
    msg.className = "message user";
    msg.innerText = text;
    chatHistory.appendChild(msg);
}

function sendMessage() {

    const text = userInput.value.trim();
    if (!text) return;

    addUserMessage(text);
    userInput.value = "";

    // =====================================
    // ðŸ”¥ MODIFY MODE HANDLING
    // =====================================
    if (modifyMode) {

        // Step selection
        if (modifyStep === null) {

            const stepNumber = parseInt(text);

            if (!isNaN(stepNumber) && stepNumber >= 1 && stepNumber <= questions.length) {
                modifyStep = stepNumber - 1;
                addBotMessage(`Enter new answer for:\n${questions[modifyStep]}`);
            } else {
                addBotMessage("Invalid step number. Please enter a valid step (1-10).");
            }

            return;
        }

        // Updating selected step
        answers[`step_${modifyStep + 1}`] = text;

        addBotMessage("Answer updated successfully.");
        addBotMessage("Regenerating floor plan...");

        modifyMode = false;
        modifyStep = null;
        awaitingConfirmation = false;

        generateFloorPlan();
        return;
    }

    // =====================================
    // ðŸ”¥ CONFIRMATION MODE
    // =====================================
    if (awaitingConfirmation) {

        if (text.toLowerCase() === "yes") {
            generateFloorPlan();
        } else if (text.toLowerCase() === "no") {
            addBotMessage("Okay. You can modify or refresh.");
        } else {
            addBotMessage("Please reply with Yes or No.");
        }

        return;
    }

    // =====================================
    // ðŸ”¥ NORMAL CHAT FLOW
    // =====================================

    answers[`step_${currentStep + 1}`] = text;
    currentStep++;

    if (currentStep < questions.length) {
        stepHeader.innerText = `Step ${currentStep + 1} of ${questions.length}`;
        addBotMessage(questions[currentStep]);
    } else {
        showSummary();
    }
}

function showSummary() {
    stepHeader.innerText = "Summary";
    addBotMessage("Here is a summary of your requirements:");
    questions.forEach((q, i) => {
        addBotMessage(`${i + 1}. ${answers[`step_${i + 1}`]}`);
    });
    addBotMessage("Shall I generate the floor plan? (Yes / No)");
    awaitingConfirmation = true;
}

function generateFloorPlan() {
    addBotMessage("Generating your floor plan...");
    userInput.disabled = true;

    fetch("/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(answers)
    })
    .then(res => res.text())
    .then(svg => {
        document.getElementById("planPreview").innerHTML = svg;
        addBotMessage("Floor plan generated successfully!");
        userInput.disabled = false;   // ðŸ”¥ re-enable input
    })
    .catch(() => {
        addBotMessage("Error generating floor plan.");
        userInput.disabled = false;
    });
}


function downloadSVG() {
    const svgElement = document.querySelector("#planPreview svg");
    if (!svgElement) {
        alert("No floor plan generated yet.");
        return;
    }

    const serializer = new XMLSerializer();
    const source = serializer.serializeToString(svgElement);
    const blob = new Blob([source], {type: "image/svg+xml;charset=utf-8"});
    const url = URL.createObjectURL(blob);

    const link = document.createElement("a");
    link.href = url;
    link.download = "floorplan.svg";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function modifyPlan() {

    if (Object.keys(answers).length === 0) {
        alert("No plan generated yet.");
        return;
    }

    modifyMode = true;
    modifyStep = null;

    addBotMessage("Which step do you want to modify? (Enter step number 1-10)");
}




function savePlan() {
    alert("Floor plan saved successfully.");
}

addBotMessage(questions[0]);
</script>

</body>
</html>
